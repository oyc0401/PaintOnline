import{Q as j,R as Z,m as q,S as E,U as V,V as K,b as v,W as w,X as Q,Y as M,Z as b,r as T,E as P,u as N,H as R,F as H,G as J,_ as ee,a0 as te,a1 as ie,T as ne,a2 as C,a3 as U,a4 as ae,a5 as oe,a6 as se,a7 as re,a8 as _,C as u,a9 as le,B as ce,L as _e,A as pe,aa as fe,I as de,O as ue,N as me,M as he,D as ye,ab as B,ac as D,q as f,n as Y,v as ge,f as ve,ad as we,i as be,x as ke,ae as xe,p as $e,af as Ee,ag as Me,l as Te,ah as De,ai as Ae,aj as Le}from"./functions.DVlDdp5e.js";function ze(){const e=window.globAppstate,c={};window.globApp=c;const G=$(".jspaint"),s=$(".canvas-area"),p=$(e.main_canvas).appendTo(s);p.css("touch-action","none"),s.css("touch-action","none");const W=new j({$handles_container:s,$object_container:s,get_rect:()=>({x:0,y:0,width:e.main_canvas.width,height:e.main_canvas.height}),set_rect:({width:t,height:i})=>Z(t,i),outset:4,get_handles_offset_left:()=>parseFloat(s.css("padding-left"))+1,get_handles_offset_top:()=>parseFloat(s.css("padding-top"))+1,get_ghost_offset_left:()=>parseFloat(s.css("padding-left"))+1,get_ghost_offset_top:()=>parseFloat(s.css("padding-top"))+1,size_only:!0}),m=$("status-text"),A=m;c.$app=G,c.update_fill_and_stroke_colors_and_lineWidth=O,c.$canvas_area=s,c.$canvas=p,c.canvas_bounding_client_rect=e.main_canvas.getBoundingClientRect(),c.canvas_handles=W,c.$status_position=m,c.$status_size=A,p.css({cursor:q(...window.globAppstate.default_tool.cursor)}),$(window).on("resize",()=>{E(),V(),K()}),s.on("scroll",()=>{E()}),s.on("resize",()=>{K()}),$(window).on("scroll focusin",()=>{window.scrollTo(0,0)}),$("body").on("dragover dragenter",t=>{const i=t.originalEvent.dataTransfer;i&&Array.from(i.types).includes("Files")&&t.preventDefault()}).on("drop",async t=>{if(t.isDefaultPrevented())return;const i=t.originalEvent.dataTransfer;if(i&&Array.from(i.types).includes("Files")){if(t.preventDefault(),window.FileSystemHandle){for(const a of i.items)if(a.kind==="file"){let o;try{"getAsFileSystemHandle"in a&&(o=await a.getAsFileSystemHandle())}catch(r){v(localize("File not found."),r);return}if(!o||o.kind==="file"){let r;try{o&&o instanceof FileSystemFileHandle?r=await o.getFile():r=a.getAsFile()}catch(l){v(localize("File not found."),l);return}if(w(r,o),window._open_images_serially)await new Promise(l=>setTimeout(l,500));else return}}}else if(i.files&&i.files.length)if(window._open_images_serially){let a=0;const o=setInterval(()=>{console.log("opening",i.files[a].name),w(i.files[a]),a++,a>=i.files.length&&clearInterval(o)},1500)}else w(i.files[0])}}),$(window).on("keydown",t=>{var i;if(t.target,!t.isDefaultPrevented()){if(t.key,(t.ctrlKey||t.metaKey)&&t.shiftKey&&!t.altKey&&t.key.toUpperCase()==="Y"){Q(),t.preventDefault();return}if(!(t.target instanceof HTMLInputElement||t.target instanceof HTMLTextAreaElement)){if(e.selection){const n=(a,o)=>{e.selection.x+=a,e.selection.y+=o,e.selection.position()};switch(t.key){case"ArrowLeft":n(-1,0),t.preventDefault();break;case"ArrowRight":n(1,0),t.preventDefault();break;case"ArrowDown":n(0,1),t.preventDefault();break;case"ArrowUp":n(0,-1),t.preventDefault();break}}if(t.key==="Escape")e.selection?M():b();else if(t.key==="Enter")e.selection&&M();else if(t.key==="F4")T();else if(t.key==="Delete"||t.key==="Backspace")t.key==="Delete"&&t.shiftKey?P():t.key==="Backspace"&&t.altKey?N():R(),t.preventDefault();else if(t.key==="Insert")t.ctrlKey?(H(),t.preventDefault()):t.shiftKey&&(J(),t.preventDefault());else if(t.code==="NumpadAdd"||t.code==="NumpadSubtract"||t.key==="+"||t.key==="-"||t.key==="="){const n=t.code==="NumpadAdd"||t.key==="+"||t.key==="=",a=t.code==="NumpadSubtract"||t.key==="-",o=Number(n)-Number(a);e.selection?e.selection.scale(2**o):(e.selected_tool.id===ee?e.brush_size=Math.max(1,Math.min(e.brush_size+o,500)):e.selected_tool.id===te?e.eraser_size=Math.max(1,Math.min(e.eraser_size+o,500)):e.selected_tool.id===ie?e.airbrush_size=Math.max(1,Math.min(e.airbrush_size+o,500)):e.selected_tool.id===ne?e.pencil_size=Math.max(1,Math.min(e.pencil_size+o,50)):(e.selected_tool.id===C||e.selected_tool.id===U||e.selected_tool.id===ae||e.selected_tool.id===oe||e.selected_tool.id===se||e.selected_tool.id===re)&&(e.stroke_size=Math.max(1,Math.min(e.stroke_size+o,500))),$(window).trigger("option-changed"),e.button!==void 0&&e.pointer&&y(e.selected_tool),_()),t.preventDefault();return}else if(t.ctrlKey||t.metaKey){if(t.key==="PageDown"){u(4),t.preventDefault();return}else if(t.key==="PageUp"){u(1),t.preventDefault();return}switch(t.key.toUpperCase()){case",":case"<":case"[":case"{":B(-D/4);break;case".":case">":case"]":case"}":B(+D/4);break;case"Z":t.shiftKey?T():N();break;case"Y":T();break;case"G":break;case"F":!t.repeat&&!((i=t.originalEvent)!=null&&i.repeat)&&ye();break;case"O":he();break;case"S":t.shiftKey?ue():me();break;case"A":de();break;case"I":fe();break;case"E":pe();break;case"N":t.shiftKey?ce():_e();break;case"R":le();break;case"W":break;default:return}t.preventDefault()}}}});const k={.5:1,1:2,2:3,3:4,4:5,5:6,6:8,8:10,10:12,12:15,15:20,20:25,25:30,30:40,40:50,50:60,60:75,75:100,100:100},L={100:75,75:60,60:50,50:40,40:30,30:25,25:20,20:15,15:12,12:10,10:8,8:6,6:5,5:4,4:3,3:2,2:1,1:.5,.5:.5};function h(t){const i=Object.keys(k).map(Number).sort((n,a)=>n-a);for(let n=i.length-1;n>=0;n--)if(t>=i[n])return i[n];return i[0]}addEventListener("wheel",t=>{if(t.altKey||t.ctrlKey){t.preventDefault();let i=e.magnification;t.deltaY<0?i=k[h(window.globAppstate.magnification)]:i=L[h(window.globAppstate.magnification)],u(i,f(t));return}},{passive:!1}),$(window).on("cut copy paste",t=>{if(t.isDefaultPrevented()||document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||!window.getSelection().isCollapsed)return;t.preventDefault();const i=t.originalEvent.clipboardData||window.clipboardData;if(i){if(t.type==="copy"||t.type==="cut"){if(e.selection&&e.selection.canvas){const n=()=>{const a=e.selection.canvas.toDataURL();i.setData("text/x-data-uri; type=image/png",a),i.setData("text/uri-list",a),i.setData("URL",a),t.type==="cut"&&R({name:localize("Cut"),icon:Y("p_cut.png")})};if(!navigator.clipboard||!navigator.clipboard.write)return n();try{t.type==="cut"?P():H()}catch{n()}}}else if(t.type==="paste"){for(const n of i.items)if(n.type.match(/^text\/(?:x-data-uri|uri-list|plain)|URL$/)){n.getAsString(a=>{const o=ge(a);o.length>0?ve(o[0]).then(r=>{we(r.image||be(r.image_data))},r=>{ke(r)}):v("The information on the Clipboard can't be inserted into Paint.")});break}else if(n.type.match(/^image\//)){xe(n.getAsFile());break}}}}),$e(),Ee(),Me(),u(e.default_magnification),Te.get({width:e.default_canvas_width,height:e.default_canvas_height},(t,i)=>{t||(e.my_canvas_width=Number(i.width),e.my_canvas_height=Number(i.height),De({match:n=>n.name===localize("New"),name:"Resize Canvas For New Document",icon:Y("p_stretch_both.png")},()=>{e.main_canvas.width=Math.max(1,e.my_canvas_width),e.main_canvas.height=Math.max(1,e.my_canvas_height),e.main_ctx.disable_image_smoothing(),e.transparency||(e.main_ctx.fillStyle=e.selected_colors.background,e.main_ctx.fillRect(0,0,e.main_canvas.width,e.main_canvas.height)),s.trigger("resize")}))}),window.initial_system_file_handle&&systemHooks.readBlobFromHandle(window.initial_system_file_handle).then(t=>{t&&w(t,window.initial_system_file_handle)},t=>{v(`Failed to open file ${window.initial_system_file_handle}`,t)});function O(t){e.main_ctx.lineWidth=e.stroke_size;const i=!!(t.$options&&t.$options.fill&&!t.$options.stroke),n=e.ctrl&&e.selected_colors.ternary&&e.pointer_active?"ternary":e.reverse!==i?"background":"foreground";e.main_ctx.fillStyle=e.fill_color=e.main_ctx.strokeStyle=e.stroke_color=e.selected_colors[n];let a=e.ctrl?"ternary":e.reverse!==i?"background":"foreground",o=a;(t.shape||t.shape_colors)&&(t.stroke_only||(e.reverse!==i?(a="foreground",o="background"):(a="background",o="foreground")),e.main_ctx.fillStyle=e.fill_color=e.selected_colors[a],e.main_ctx.strokeStyle=e.stroke_color=e.selected_colors[o]),e.pick_color_slot=a}function y(t,i){O(t),t[i]&&t[i](e.main_ctx,e.pointer.x,e.pointer.y),t.paint&&t.paint(e.main_ctx,e.pointer.x,e.pointer.y)}function z(t){if(e.ctrl=t.ctrlKey,e.shift=t.shiftKey,e.pointer=f(t),e.pointers.length&&t.button!=-1&&(t.pointerType!=e.pointer_type||(t.buttons|4)!=(e.pointer_buttons|4))){b(),e.pointer_active=!1;return}if(t.shiftKey){if(e.selected_tool.id===C||e.selected_tool.id===U){const i=Math.sqrt((e.pointer.y-e.pointer_start.y)*(e.pointer.y-e.pointer_start.y)+(e.pointer.x-e.pointer_start.x)*(e.pointer.x-e.pointer_start.x)),n=D/8,a=Math.atan2(e.pointer.y-e.pointer_start.y,e.pointer.x-e.pointer_start.x)/n,o=Math.round(a)*n;e.pointer.x=Math.round(e.pointer_start.x+Math.cos(o)*i),e.pointer.y=Math.round(e.pointer_start.y+Math.sin(o)*i)}else if(e.selected_tool.shape){const i=Math.abs(e.pointer.x-e.pointer_start.x),n=Math.abs(e.pointer.y-e.pointer_start.y);i<n?e.pointer.y>e.pointer_start.y?e.pointer.y=e.pointer_start.y+i:e.pointer.y=e.pointer_start.y-i:e.pointer.x>e.pointer_start.x?e.pointer.x=e.pointer_start.x+n:e.pointer.x=e.pointer_start.x-n}}e.selected_tools.forEach(i=>{y(i)}),e.pointer_previous=e.pointer}p.on("pointermove",t=>{e.pointer=f(t),m.text(`${e.pointer.x}, ${e.pointer.y} px`)}),p.on("pointerenter",t=>{e.pointer_over_canvas=!0,_(t),e.update_helper_layer_on_pointermove_active||($(window).on("pointermove",_),e.update_helper_layer_on_pointermove_active=!0)}),p.on("pointerleave",t=>{e.pointer_over_canvas=!1,m.text(""),_(t),!e.pointer_active&&e.update_helper_layer_on_pointermove_active&&($(window).off("pointermove",_),e.update_helper_layer_on_pointermove_active=!1)});let x,g,d;const S=500;function F(t){const i={x:0,y:0};for(const n of t)i.x+=n.x,i.y+=n.y;return i.x/=t.length,i.y/=t.length,i}s.on("pointerdown",t=>{if(document.activeElement instanceof HTMLElement&&document.activeElement!==document.body&&document.activeElement!==document.documentElement&&document.activeElement.blur(),e.pointers.every(i=>i.pointerId!==1234567890&&!(i.isPrimary&&(i.pointerType==="mouse"||i.pointerType==="pen")))&&e.pointers.push({pointerId:t.pointerId,pointerType:t.pointerType,isPrimary:t.originalEvent&&t.originalEvent.isPrimary||t.isPrimary,x:t.clientX,y:t.clientY}),e.pointers.length===1&&(d=performance.now()),e.pointers.length==2&&(x=Math.hypot(e.pointers[0].x-e.pointers[1].x,e.pointers[0].y-e.pointers[1].y),g=F(e.pointers)),e.pointers.length>=2){const i=d&&performance.now()-d<S;b(!1,i),e.pointer_active=!1;return}}),$(window).on("pointerup pointercancel",t=>{e.pointers=e.pointers.filter(i=>i.pointerId!==t.pointerId)}),$(window).on("pointermove",t=>{for(const i of e.pointers)i.pointerId===t.pointerId&&(i.x=t.clientX,i.y=t.clientY);if(e.pointers.length>=2){const i=F(e.pointers),n=Math.hypot(e.pointers[0].x-e.pointers[1].x,e.pointers[0].y-e.pointers[1].y),a=n-x;let o=e.magnification;Math.abs(a)>60&&(x=n,a>0?o=k[h(window.globAppstate.magnification)]:o=L[h(window.globAppstate.magnification)]),o!=e.magnification&&u(o,f({clientX:i.x,clientY:i.y}));const r=i.x-g.x,l=i.y-g.y;s.scrollLeft(s.scrollLeft()-r),s.scrollTop(s.scrollTop()-l),g=i}}),p.on("pointerdown",t=>{if(A.text(""),E(),e.pointers.length>=1){const n=d&&performance.now()-d<S;b(!1,n),e.pointer_active=!1,e.pointers=e.pointers.filter(a=>a.pointerId!==1234567890);return}if(e.history_node_to_cancel_to=e.current_history_node,e.pointer_active=!!(t.buttons&3),e.pointer_type=t.pointerType,e.pointer_buttons=t.buttons,$(window).one("pointerup",n=>{e.pointer_active=!1,_(n),!e.pointer_over_canvas&&e.update_helper_layer_on_pointermove_active&&($(window).off("pointermove",_),e.update_helper_layer_on_pointermove_active=!1)}),t.button===0)e.reverse=!1;else if(t.button===2)e.reverse=!0;else return;e.button=t.button,e.ctrl=t.ctrlKey,e.shift=t.shiftKey,e.pointer_start=e.pointer_previous=e.pointer=f(t),(()=>{let n=[];e.selected_tools.forEach(a=>{(a.paint||a.pointerdown)&&y(a,"pointerdown"),a.paint_on_time_interval!=null&&n.push(setInterval(()=>{y(a)},a.paint_on_time_interval))}),$(window).on("pointermove",z),$(window).one("pointerup",(a,o,r)=>{e.button=void 0,e.reverse=!1,a.clientX!==void 0&&(e.pointer=f(a),console.log("appState.pointer:",e.pointer)),r||e.selected_tools.forEach(l=>{var I;(I=l.pointerup)==null||I.call(l,e.main_ctx,e.pointer.x,e.pointer.y)}),e.selected_tools.length===1&&e.selected_tool.deselect&&Ae(e.return_to_tools),$(window).off("pointermove",z);for(const l of n)clearInterval(l);o||(e.history_node_to_cancel_to=null)})})(),_(t)}),s.on("pointerdown",t=>{t.button===0&&s.is(t.target)&&e.selection&&M()}),$(window).on("blur",()=>{$(window).triggerHandler("pointerup")});function X(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}$("html").toggleClass("ios",X()),$(window).on("fullscreenchange webkitfullscreenchange",()=>{const t=!!(document.fullscreenElement||document.webkitFullscreenElement);$("html").toggleClass("fullscreen",t)}),Le()}export{ze as setupApp};
