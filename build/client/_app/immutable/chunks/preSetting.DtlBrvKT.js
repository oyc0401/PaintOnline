import{s as L,a as Z,b as h,e as G,t as K,g as V,c as Y,m as J,$ as d,u as Q,r as ee,l as E,d as D,f as M,o as B,h as g,i as x,j,k as P,n as W,p as N,q as se,v as te,w as F,x as ae}from"./functions.DVlDdp5e.js";import"./menus.l85aPSSQ.js";function ne(){console.log("presetting"),window.defaultMessageBoxTitle=localize("Paint"),window.showMessageBox=L,window.are_you_sure=Z,window.show_error_message=h,window.exit_fullscreen_if_ios=G,window.tools=K,window.svelteApp={},window.svelteApp.get_tool_by_id=V,window.svelteApp.select_tool=Y,window.svelteApp.make_css_cursor=J}function re(){console.log("setSession");const o=(...n)=>{var e;(e=window.console)==null||e.log(...n)};let R=!1;try{localStorage._available=!0,R=localStorage._available,delete localStorage._available}catch{}const O=1,q=()=>window.globAppstate.main_canvas.ctx.getImageData(0,0,window.globAppstate.main_canvas.width,window.globAppstate.main_canvas.height).data.some(n=>n>O);let u;function T(n){u==null||u.close();const e=u=$DialogWindow();e.on("close",()=>{u=null}),e.title("Recover Document");let t=!1;try{window.localStorage.getItem("bogus test key")}catch{t=!0}e.$main.append($(`
         <p>Woah! The canvas became empty.</p>
         <p>If this was on purpose, please ignore this message.</p>
         <p>
            If the canvas was cleared due to memory usage,<br>
            click Undo to recover the document.
         </p>
         <!--<p>Remember to save with <b>File > Save</b>!</p>-->
         ${t?"<p><b>Note:</b> No automatic backup is possible unless you enable Cookies in your browser.</p>":n?`<hr>
                  <p style="opacity: 0.8; font-size: 0.9em;">
                     Auto-save is paused while this dialog is open.
                  </p>
                  <p style="opacity: 0.8; font-size: 0.9em;">
                     (See <b>File &gt; Manage Storage</b> to view backups.)
                  </p>`:""}
      `));const s=e.$Button("Undo",()=>{Q()}),a=e.$Button("Redo",()=>{ee()}),i=()=>{s.prop("disabled",window.globAppstate.undos.length<1),a.prop("disabled",window.globAppstate.redos.length<1)};d.on("session-update.session-hook",i),i(),e.$Button(localize("Close"),()=>{e.close()}),e.center(),e.find("button:enabled").focus()}let U=window.globAppstate.undos.length;function y(){const n=u&&!u.closed;let e=!1;return q()?n&&(window.globAppstate.undos.length>U&&T(!0),e=!0):(n||T(),e=!0),U=window.globAppstate.undos.length,e}class S{constructor(e){this.id=e;const t=`image#${e}`;o(`Local storage key: ${t}`),this.save_image_to_storage_immediately=()=>{y()||(o(`Saving image to storage: ${t}`),E.set(t,window.globAppstate.main_canvas.toDataURL("image/png"),a=>{}))},this.save_image_to_storage_soon=D(this.save_image_to_storage_immediately,100),E.get(t,(s,a)=>{s?R?h("Failed to retrieve image from local storage.",s):L({message:"Please enable local storage in your browser's settings for local backup. It may be called Cookies, Storage, or Site Data."}):a?M(a).then(i=>{B(i,null,null,!0,!0)},i=>{h("Failed to open image from local storage.",i)}):this.save_image_to_storage_soon()}),d.on("session-update.session-hook",()=>{this.save_image_to_storage_soon()})}end(){this.save_image_to_storage_soon.cancel(),this.save_image_to_storage_immediately(),d.off(".session-hook")}}let v;const l={cursor:{x:0,y:0,away:!0},tool:localize("Pencil"),hue:~~(Math.random()*360),saturation:~~(Math.random()*50)+50,lightness:~~(Math.random()*40)+50};l.color=`hsla(${l.hue}, ${l.saturation}%, ${l.lightness}%, 1)`,l.color_transparent=`hsla(${l.hue}, ${l.saturation}%, ${l.lightness}%, 0.5)`,l.color_desaturated=`hsla(${l.hue}, ${~~(l.saturation*.4)}%, ${l.lightness}%, 0.8)`;const p=new Image;p.src="images/cursors/default.png";class f{constructor(e){this.id=e,this._fb_listeners=[],window.globAppstate.file_name=`[Loading ${this.id}]`,g();const t=()=>{window.globAppstate.file_name=`[${this.id}]`,g(),this.start()};if(f.fb_root)t();else{var s=document.createElement("script");s.addEventListener("load",()=>{const a={apiKey:"AIzaSyBgau8Vu9ZE8u_j0rp-Lc044gYTX5O3X9k",authDomain:"jspaint.firebaseapp.com",databaseURL:"https://jspaint.firebaseio.com",projectId:"firebase-jspaint",storageBucket:"",messagingSenderId:"63395010995"};firebase.initializeApp(a),f.fb_root=firebase.database().ref("/"),t()}),s.addEventListener("error",()=>{h("Failed to load Firebase; the document will not load, and changes will not be saved."),window.globAppstate.file_name=`[Failed to load ${this.id}]`,g()}),s.src="lib/firebase.js",document.head.appendChild(s)}}start(){L({messageHTML:`
               <p>The document may not load. Changes may not save.</p>
               <p>Multiuser sessions are public. There is no security.</p>
            `});const e=(a,i,r,_)=>{this._fb_listeners.push({fb:a,event_type:i,callback:r,error_callback:_}),a.on(i,r,_)};this.fb=f.fb_root.child(this.id),this.fb_data=this.fb.child("data"),this.fb_users=this.fb.child("users"),v?this.fb_user=this.fb_users.child(v):(this.fb_user=this.fb_users.push(),v=this.fb_user.key),this.fb_user.onDisconnect().remove(),this.fb_user.set(l),e(this.fb_users,"child_added",a=>{if(a.key===v)return;const i=a.ref;let r=a.val();const _=x(32,32),b=$(_).addClass("user-cursor").appendTo($app);b.css({display:"none",position:"absolute",left:0,top:0,opacity:0,zIndex:5,pointerEvents:"none",transition:"opacity 0.5s"}),e(i,"value",k=>{if(r=k.val(),r==null)b.remove();else{const z=()=>{_.width=p.width,_.height=p.height;const w=_.ctx;w.fillStyle=r.color,w.fillRect(0,0,_.width,_.height),w.globalCompositeOperation="multiply",w.drawImage(p,0,0),w.globalCompositeOperation="destination-atop",w.drawImage(p,0,0)};p.complete?z():$(p).one("load",z);const C=window.globApp.canvas_bounding_client_rect;b.css({display:"block",position:"absolute",left:C.left+magnification*r.cursor.x,top:C.top+magnification*r.cursor.y,opacity:1-r.cursor.away})}})});let t;this.write_canvas_to_database_immediately=()=>{if(y())return;const i=window.globAppstate.main_canvas.toDataURL();t!==i?(o("Write canvas data to Firebase"),this.fb_data.set(i),t=i):o("(Don't write canvas data to Firebase; it hasn't changed)")},this.write_canvas_to_database_soon=D(this.write_canvas_to_database_immediately,100);let s=!1;d.on("session-update.session-hook",()=>{if(s){o("(Ignore session-update from Sync Session undoable)");return}this.write_canvas_to_database_soon()}),e(this.fb_data,"value",a=>{o("Firebase data update");const i=a.val();if(i==null)this.write_canvas_to_database_soon();else{t=i;const r=new Image;r.onload=()=>{const _=x(r),b=_.ctx.getImageData(0,0,_.width,_.height),k=window.globAppstate.main_ctx.getImageData(0,0,window.globAppstate.main_canvas.width,window.globAppstate.main_canvas.height);j(b,k,5)||(s=!0,P({name:"Sync Session",icon:W("p_database.png")},()=>{window.globAppstate.main_ctx.copy(r),$canvas_area.trigger("resize")}),s=!1)},r.src=i}},a=>{h("Failed to retrieve data from Firebase. The document will not load, and changes will not be saved.",a),window.globAppstate.file_name=`[Failed to load ${this.id}]`,g()}),d.on("pointermove.session-hook",a=>{const i=se(a);this.fb_user.child("cursor").update({x:i.x,y:i.y,away:!1})}),d.on("blur.session-hook",()=>{this.fb_user.child("cursor").update({away:!0})})}end(){this.write_canvas_to_database_soon.cancel(),this.write_canvas_to_database_immediately(),d.off(".session-hook"),this._fb_listeners.forEach(({fb:e,event_type:t,callback:s,_error_callback:a})=>{o(`Remove listener for ${e.path.toString()} .on ${t}`),e.off(t,s)}),this._fb_listeners.length=0,this.fb_user.remove(),$app.find(".user-cursor").remove(),N()}}f.fb_root=null;class H{constructor(e){this.id=e,window.globAppstate.file_name=`[Loading ${this.id}]`,g(),this.start(),this._previous_uri="",this._ignore_session_update=!1,this._poll_tid=-1,this._poll_fetch_start_time=-1,this._last_write_time=-1}async _write_canvas_to_server_immediately(){if(y())return;const t=window.globAppstate.main_canvas.toDataURL();this._previous_uri!==t?(o("Write canvas data to server"),this._previous_uri=t,this._last_write_time=performance.now(),await fetch(`/api/rooms/${this.id}/data`,{method:"PUT",body:t}),this._last_write_time=performance.now()):o("(Don't write canvas data to server; it hasn't changed)")}start(){this._write_canvas_to_server_soon=D(this._write_canvas_to_server_immediately,100),d.on("session-update.session-hook",()=>{if(this._ignore_session_update){o("(Ignore session-update from Sync Session undoable)");return}this._write_canvas_to_server_soon(),this._last_write_time=performance.now()});const e=async()=>{let t;try{this._poll_fetch_start_time=performance.now();const s=await fetch(`/api/rooms/${this.id}/data`);s.status===404?t=null:t=await s.text()}catch(s){h("Failed to load image document from the server.",s),window.globAppstate.file_name=`[Failed to load ${this.id}]`,g();return}window.globAppstate.file_name=`[${this.id}]`,g(),this.handle_data_snapshot(t,this._poll_fetch_start_time),this._poll_tid=setTimeout(e,1e3)};e()}handle_data_snapshot(e,t){if(!e)this._write_canvas_to_server_soon(),this._last_write_time=performance.now();else{this._previous_uri=e;const s=new Image;s.onload=()=>{if(this._last_write_time>t){o("(Ignore stale image data)");return}const a=x(s),i=a.ctx.getImageData(0,0,a.width,a.height),r=window.globAppstate.main_ctx.getImageData(0,0,window.globAppstate.main_canvas.width,window.globAppstate.main_canvas.height);j(i,r,5)||(this._ignore_session_update=!0,P({name:"Sync Session",icon:W("p_database.png")},()=>{window.globAppstate.main_ctx.copy(s),$canvas_area.trigger("resize")}),this._ignore_session_update=!1)},s.onerror=()=>{h("Failed to load image document from the server. Invalid image data.",e)},s.src=e}}end(){clearTimeout(this._poll_tid),this._write_canvas_to_server_soon.cancel(),this._write_canvas_to_server_immediately(),d.off(".session-hook"),$app.find(".user-cursor").remove(),N()}}let c;const m=()=>{c&&(o("Ending current session"),c.end(),c=null)},I=()=>(Math.random()*2**32).toString(16).replace(".",""),A=()=>{const n=location.hash.match(/^#?(?:.*,)?(session|local):(.*)$/i),e=location.hash.match(/^#?(?:.*,)?(load):(.*)$/i);if(n){const t=n[1].toLowerCase()==="local",s=n[2];if(s==="")o("Invalid session ID; session ID cannot be empty"),m();else if(!t&&s.match(/[./[\]#$]/))o("Session ID is not a valid Firebase location; it cannot contain any of ./[]#$"),m();else if(!s.match(/[-0-9A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02af\u1d00-\u1d25\u1d62-\u1d65\u1d6b-\u1d77\u1d79-\u1d9a\u1e00-\u1eff\u2090-\u2094\u2184-\u2184\u2488-\u2490\u271d-\u271d\u2c60-\u2c7c\u2c7e-\u2c7f\ua722-\ua76f\ua771-\ua787\ua78b-\ua78c\ua7fb-\ua7ff\ufb00-\ufb06]+/))o("Invalid session ID; it must consist of 'alphanumeric-esque' characters"),m();else if(c&&c.id===s&&t===c instanceof S)o("Hash changed but the session ID and session type are the same");else{m();let a="FirebaseSession";try{a=localStorage.online_session_implementation||a}catch{}t?(o(`Starting a new LocalSession, ID: ${s}`),c=new S(s)):a==="RESTSession"?(o(`Starting a new RESTSession, ID: ${s}`),c=new H(s)):a==="FirebaseSession"?(o(`Starting a new FirebaseSession, ID: ${s}`),c=new f(s)):(h(`Invalid online session implementation '${a}'`),c=new S(s))}}else if(e){const t=decodeURIComponent(e[2]);if(te(t).length===0){h("Invalid URL to load (after #load: in the address bar). It must include a protocol (https:// or http://)");return}o("Switching to new session from #load: URL (to #local: URL with session ID)"),m(),F("local",I()),M(t).then(a=>{B(a,null,null,!0,!0)},ae)}else{o("No session ID in hash");const t=location.hash;m(),F("local",I(),{replace_history_state:!0}),o("After replaceState:",location.hash),t===location.hash?h("Autosave is disabled. Failed to update URL to start session."):A()}};d.on("hashchange popstate change-url-params",n=>{o(n.type,location.hash),A()});const X=()=>{m(),o("Changing URL to start new session..."),F("local",I())};o("Initializing with location hash:",location.hash),A(),window.new_local_session=X}export{ne as preSetting,re as setSession};
