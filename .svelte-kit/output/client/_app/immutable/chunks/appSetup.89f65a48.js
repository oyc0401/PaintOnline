import{H as Y,m as G,A as k,B as W,C as X,b as g,D as v,E as j,F as x,G as w,x as E,I as S,w as F,J as I,K,L as q,M as V,N as Z,O as J,T as Q,P,Q as N,R as ee,S as te,U as ie,V as ne,W as _,X as u,Y as ae,Z as oe,_ as se,a0 as re,a1 as le,a2 as ce,a3 as _e,a4 as pe,a5 as fe,a6 as de,a7 as R,k as f,d as ue,l as me,a8 as he,n as ye,h as ge,a9 as ve,r as we,aa as be,ab as ke,i as xe,ac as $e,v as H,ad as Ee,ae as Me,af as M,ag as Te}from"./menus.187906b6.js";console.log("setup app");function Le(){const e=window.globAppstate,c={};window.globApp=c;const C=$(".jspaint"),s=$(".canvas-area"),p=$(e.main_canvas).appendTo(s);p.css("touch-action","none");const U=new Y({$handles_container:s,$object_container:s,get_rect:()=>({x:0,y:0,width:e.main_canvas.width,height:e.main_canvas.height}),set_rect:({width:t,height:i})=>Me(t,i),outset:4,get_handles_offset_left:()=>parseFloat(s.css("padding-left"))+1,get_handles_offset_top:()=>parseFloat(s.css("padding-top"))+1,get_ghost_offset_left:()=>parseFloat(s.css("padding-left"))+1,get_ghost_offset_top:()=>parseFloat(s.css("padding-top"))+1,size_only:!0}),m=$("status-text"),T=m;c.$app=C,c.update_fill_and_stroke_colors_and_lineWidth=D,c.$canvas_area=s,c.$canvas=p,c.canvas_bounding_client_rect=e.main_canvas.getBoundingClientRect(),c.canvas_handles=U,c.$status_position=m,c.$status_size=T,p.css({cursor:G(...window.globAppstate.default_tool.cursor)}),$(window).on("resize",()=>{k(),W()}),s.on("scroll",()=>{k()}),s.on("resize",()=>{console.log("resize"),X()}),$(window).on("scroll focusin",()=>{window.scrollTo(0,0)}),$("body").on("dragover dragenter",t=>{const i=t.originalEvent.dataTransfer;i&&Array.from(i.types).includes("Files")&&t.preventDefault()}).on("drop",async t=>{if(t.isDefaultPrevented())return;const i=t.originalEvent.dataTransfer;if(i&&Array.from(i.types).includes("Files")){if(t.preventDefault(),window.FileSystemHandle){for(const n of i.items)if(n.kind==="file"){let o;try{"getAsFileSystemHandle"in n&&(o=await n.getAsFileSystemHandle())}catch(r){g(localize("File not found."),r);return}if(!o||o.kind==="file"){let r;try{o&&o instanceof FileSystemFileHandle?r=await o.getFile():r=n.getAsFile()}catch(l){g(localize("File not found."),l);return}if(v(r,o),window._open_images_serially)await new Promise(l=>setTimeout(l,500));else return}}}else if(i.files&&i.files.length)if(window._open_images_serially){let n=0;const o=setInterval(()=>{console.log("opening",i.files[n].name),v(i.files[n]),n++,n>=i.files.length&&clearInterval(o)},1500)}else v(i.files[0])}}),$(window).on("keydown",t=>{var i;if(t.target,!t.isDefaultPrevented()){if(t.key,(t.ctrlKey||t.metaKey)&&t.shiftKey&&!t.altKey&&t.key.toUpperCase()==="Y"){j(),t.preventDefault();return}if(!(t.target instanceof HTMLInputElement||t.target instanceof HTMLTextAreaElement)){if(e.selection){const a=(n,o)=>{e.selection.x+=n,e.selection.y+=o,e.selection.position()};switch(t.key){case"ArrowLeft":a(-1,0),t.preventDefault();break;case"ArrowRight":a(1,0),t.preventDefault();break;case"ArrowDown":a(0,1),t.preventDefault();break;case"ArrowUp":a(0,-1),t.preventDefault();break}}if(t.key==="Escape")e.selection?x():w();else if(t.key==="Enter")e.selection&&x();else if(t.key==="F4")E();else if(t.key==="Delete"||t.key==="Backspace")t.key==="Delete"&&t.shiftKey?S():t.key==="Backspace"&&t.altKey?F():I(),t.preventDefault();else if(t.key==="Insert")t.ctrlKey?(K(),t.preventDefault()):t.shiftKey&&(q(),t.preventDefault());else if(t.code==="NumpadAdd"||t.code==="NumpadSubtract"||t.key==="+"||t.key==="-"||t.key==="="){const a=t.code==="NumpadAdd"||t.key==="+"||t.key==="=",n=t.code==="NumpadSubtract"||t.key==="-",o=Number(a)-Number(n);e.selection?e.selection.scale(2**o):(e.selected_tool.id===V?e.brush_size=Math.max(1,Math.min(e.brush_size+o,500)):e.selected_tool.id===Z?e.eraser_size=Math.max(1,Math.min(e.eraser_size+o,500)):e.selected_tool.id===J?e.airbrush_size=Math.max(1,Math.min(e.airbrush_size+o,500)):e.selected_tool.id===Q?e.pencil_size=Math.max(1,Math.min(e.pencil_size+o,50)):(e.selected_tool.id===P||e.selected_tool.id===N||e.selected_tool.id===ee||e.selected_tool.id===te||e.selected_tool.id===ie||e.selected_tool.id===ne)&&(e.stroke_size=Math.max(1,Math.min(e.stroke_size+o,500))),$(window).trigger("option-changed"),e.button!==void 0&&e.pointer&&h(e.selected_tool),_()),t.preventDefault();return}else if(t.ctrlKey||t.metaKey){if(t.key==="PageDown"){u(4),t.preventDefault();return}else if(t.key==="PageUp"){u(1),t.preventDefault();return}switch(t.key.toUpperCase()){case",":case"<":case"[":case"{":R(-M/4);break;case".":case">":case"]":case"}":R(+M/4);break;case"Z":t.shiftKey?E():F();break;case"Y":E();break;case"G":break;case"F":!t.repeat&&!((i=t.originalEvent)!=null&&i.repeat)&&de();break;case"O":fe();break;case"S":t.shiftKey?_e():pe();break;case"A":ce();break;case"I":le();break;case"E":re();break;case"N":t.shiftKey?oe():se();break;case"R":ae();break;case"W":break;default:return}t.preventDefault()}}}}),addEventListener("wheel",t=>{if(t.altKey||t.ctrlKey){t.preventDefault();let i=e.magnification;t.deltaY<0?i*=1.5:i/=1.5,i=Math.max(.5,Math.min(i,80)),u(i,f(t));return}},{passive:!1}),$(window).on("cut copy paste",t=>{if(t.isDefaultPrevented()||document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||!window.getSelection().isCollapsed)return;t.preventDefault();const i=t.originalEvent.clipboardData||window.clipboardData;if(i){if(t.type==="copy"||t.type==="cut"){if(e.selection&&e.selection.canvas){const a=()=>{const n=e.selection.canvas.toDataURL();i.setData("text/x-data-uri; type=image/png",n),i.setData("text/uri-list",n),i.setData("URL",n),t.type==="cut"&&I({name:localize("Cut"),icon:H("p_cut.png")})};if(!navigator.clipboard||!navigator.clipboard.write)return a();try{t.type==="cut"?S():K()}catch{a()}}}else if(t.type==="paste"){for(const a of i.items)if(a.type.match(/^text\/(?:x-data-uri|uri-list|plain)|URL$/)){a.getAsString(n=>{const o=ue(n);o.length>0?me(o[0]).then(r=>{he(r.image||ye(r.image_data))},r=>{ge(r)}):g("The information on the Clipboard can't be inserted into Paint.")});break}else if(a.type.match(/^image\//)){ve(a.getAsFile());break}}}}),we(),be(),ke(),u(e.default_magnification),xe.get({width:e.default_canvas_width,height:e.default_canvas_height},(t,i)=>{t||(e.my_canvas_width=Number(i.width),e.my_canvas_height=Number(i.height),$e({match:a=>a.name===localize("New"),name:"Resize Canvas For New Document",icon:H("p_stretch_both.png")},()=>{e.main_canvas.width=Math.max(1,e.my_canvas_width),e.main_canvas.height=Math.max(1,e.my_canvas_height),e.main_ctx.disable_image_smoothing(),e.transparency||(e.main_ctx.fillStyle=e.selected_colors.background,e.main_ctx.fillRect(0,0,e.main_canvas.width,e.main_canvas.height)),s.trigger("resize")}))}),window.initial_system_file_handle&&systemHooks.readBlobFromHandle(window.initial_system_file_handle).then(t=>{t&&v(t,window.initial_system_file_handle)},t=>{g(`Failed to open file ${window.initial_system_file_handle}`,t)});function D(t){e.main_ctx.lineWidth=e.stroke_size;const i=!!(t.$options&&t.$options.fill&&!t.$options.stroke),a=e.ctrl&&e.selected_colors.ternary&&e.pointer_active?"ternary":e.reverse!==i?"background":"foreground";e.main_ctx.fillStyle=e.fill_color=e.main_ctx.strokeStyle=e.stroke_color=e.selected_colors[a];let n=e.ctrl?"ternary":e.reverse!==i?"background":"foreground",o=n;(t.shape||t.shape_colors)&&(t.stroke_only||(e.reverse!==i?(n="foreground",o="background"):(n="background",o="foreground")),e.main_ctx.fillStyle=e.fill_color=e.selected_colors[n],e.main_ctx.strokeStyle=e.stroke_color=e.selected_colors[o]),e.pick_color_slot=n}function h(t,i){D(t),t[i]&&t[i](e.main_ctx,e.pointer.x,e.pointer.y),t.paint&&t.paint(e.main_ctx,e.pointer.x,e.pointer.y)}function L(t){if(e.ctrl=t.ctrlKey,e.shift=t.shiftKey,e.pointer=f(t),e.pointers.length&&t.button!=-1&&(t.pointerType!=e.pointer_type||(t.buttons|4)!=(e.pointer_buttons|4))){w(),e.pointer_active=!1;return}if(t.shiftKey){if(e.selected_tool.id===P||e.selected_tool.id===N){const i=Math.sqrt((e.pointer.y-e.pointer_start.y)*(e.pointer.y-e.pointer_start.y)+(e.pointer.x-e.pointer_start.x)*(e.pointer.x-e.pointer_start.x)),a=M/8,n=Math.atan2(e.pointer.y-e.pointer_start.y,e.pointer.x-e.pointer_start.x)/a,o=Math.round(n)*a;e.pointer.x=Math.round(e.pointer_start.x+Math.cos(o)*i),e.pointer.y=Math.round(e.pointer_start.y+Math.sin(o)*i)}else if(e.selected_tool.shape){const i=Math.abs(e.pointer.x-e.pointer_start.x),a=Math.abs(e.pointer.y-e.pointer_start.y);i<a?e.pointer.y>e.pointer_start.y?e.pointer.y=e.pointer_start.y+i:e.pointer.y=e.pointer_start.y-i:e.pointer.x>e.pointer_start.x?e.pointer.x=e.pointer_start.x+a:e.pointer.x=e.pointer_start.x-a}}e.selected_tools.forEach(i=>{h(i)}),e.pointer_previous=e.pointer}p.on("pointermove",t=>{e.pointer=f(t),m.text(`${e.pointer.x}, ${e.pointer.y} px`)}),p.on("pointerenter",t=>{e.pointer_over_canvas=!0,_(t),e.update_helper_layer_on_pointermove_active||($(window).on("pointermove",_),e.update_helper_layer_on_pointermove_active=!0)}),p.on("pointerleave",t=>{e.pointer_over_canvas=!1,m.text(""),_(t),!e.pointer_active&&e.update_helper_layer_on_pointermove_active&&($(window).off("pointermove",_),e.update_helper_layer_on_pointermove_active=!1)});let b,y,d;const A=500;function z(t){const i={x:0,y:0};for(const a of t)i.x+=a.x,i.y+=a.y;return i.x/=t.length,i.y/=t.length,i}s.on("pointerdown",t=>{if(document.activeElement instanceof HTMLElement&&document.activeElement!==document.body&&document.activeElement!==document.documentElement&&document.activeElement.blur(),e.pointers.every(i=>i.pointerId!==1234567890&&!(i.isPrimary&&(i.pointerType==="mouse"||i.pointerType==="pen")))&&e.pointers.push({pointerId:t.pointerId,pointerType:t.pointerType,isPrimary:t.originalEvent&&t.originalEvent.isPrimary||t.isPrimary,x:t.clientX,y:t.clientY}),e.pointers.length===1&&(d=performance.now()),e.pointers.length==2&&(b=Math.hypot(e.pointers[0].x-e.pointers[1].x,e.pointers[0].y-e.pointers[1].y),y=z(e.pointers)),e.pointers.length>=2){const i=d&&performance.now()-d<A;w(!1,i),e.pointer_active=!1;return}}),$(window).on("pointerup pointercancel",t=>{e.pointers=e.pointers.filter(i=>i.pointerId!==t.pointerId)}),$(window).on("pointermove",t=>{for(const i of e.pointers)i.pointerId===t.pointerId&&(i.x=t.clientX,i.y=t.clientY);if(e.pointers.length>=2){const i=z(e.pointers),a=Math.hypot(e.pointers[0].x-e.pointers[1].x,e.pointers[0].y-e.pointers[1].y),n=a-b;let o=e.magnification;Math.abs(n)>60&&(b=a,n>0?o*=1.5:o/=1.5),o=Math.max(.5,Math.min(o,40)),o!=magnification&&u(o,f({clientX:i.x,clientY:i.y}));const r=i.x-y.x,l=i.y-y.y;s.scrollLeft(s.scrollLeft()-r),s.scrollTop(s.scrollTop()-l),y=i}}),p.on("pointerdown",t=>{if(T.text(""),k(),e.pointers.length>=1){const a=d&&performance.now()-d<A;w(!1,a),e.pointer_active=!1,e.pointers=e.pointers.filter(n=>n.pointerId!==1234567890);return}if(e.history_node_to_cancel_to=e.current_history_node,e.pointer_active=!!(t.buttons&3),e.pointer_type=t.pointerType,e.pointer_buttons=t.buttons,$(window).one("pointerup",a=>{e.pointer_active=!1,_(a),!e.pointer_over_canvas&&e.update_helper_layer_on_pointermove_active&&($(window).off("pointermove",_),e.update_helper_layer_on_pointermove_active=!1)}),t.button===0)e.reverse=!1;else if(t.button===2)e.reverse=!0;else return;e.button=t.button,e.ctrl=t.ctrlKey,e.shift=t.shiftKey,e.pointer_start=e.pointer_previous=e.pointer=f(t),(()=>{let a=[];e.selected_tools.forEach(n=>{(n.paint||n.pointerdown)&&h(n,"pointerdown"),n.paint_on_time_interval!=null&&a.push(setInterval(()=>{h(n)},n.paint_on_time_interval))}),$(window).on("pointermove",L),$(window).one("pointerup",(n,o,r)=>{e.button=void 0,e.reverse=!1,n.clientX!==void 0&&(e.pointer=f(n)),r||e.selected_tools.forEach(l=>{var O;(O=l.pointerup)==null||O.call(l,e.main_ctx,e.pointer.x,e.pointer.y)}),e.selected_tools.length===1&&e.selected_tool.deselect&&Te(e.return_to_tools),$(window).off("pointermove",L);for(const l of a)clearInterval(l);o||(e.history_node_to_cancel_to=null)})})(),_(t)}),s.on("pointerdown",t=>{t.button===0&&s.is(t.target)&&e.selection&&x()}),$(window).on("blur",()=>{$(window).triggerHandler("pointerup")});function B(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}$("html").toggleClass("ios",B()),$(window).on("fullscreenchange webkitfullscreenchange",()=>{const t=!!(document.fullscreenElement||document.webkitFullscreenElement);$("html").toggleClass("fullscreen",t)}),Ee()}export{Le as setupApp};
