import{s as U,a as J,b as u,e as Q,t as ee,g as se,c as te,m as ae,$ as h,d as oe,f as z,l as P,o as W,h as ie,i as N,j as T,u as b,k as ne,r as O,n as A,p as q,q as H,v as X,w as re,x as le}from"./menus.187906b6.js";function ss(){console.log("presetting"),window.defaultMessageBoxTitle=localize("Paint"),window.showMessageBox=U,window.are_you_sure=J,window.show_error_message=u,window.exit_fullscreen_if_ios=Q,window.tools=ee,window.svelteApp={},window.svelteApp.get_tool_by_id=se,window.svelteApp.select_tool=te,window.svelteApp.make_css_cursor=ae}function ts(){console.log("setSession");let{return_to_magnification:_e,main_canvas:c,main_ctx:S,palette:ce,polychrome_palette:de,enable_palette_loading_from_indexed_images:he,enable_fs_access_api:ue,brush_shape:pe,brush_size:me,eraser_size:fe,airbrush_size:ge,pencil_size:be,stroke_size:we,tool_transparent_mode:ve,stroke_color:ye,fill_color:$e,pick_color_slot:Se,selected_tool:Ie,selected_tools:ke,return_to_tools:De,selected_colors:xe,selection:Fe,helper_layer:Le,$thumbnail_window:Re,thumbnail_canvas:ze,show_grid:Te,show_thumbnail:Ae,text_tool_font:Ue,root_history_node:Ce,current_history_node:Ee,history_node_to_cancel_to:Me,undos:I,redos:Z,file_name:p,file_format:Be,system_file_handle:je,saved:Pe,pointer:We,pointer_start:Ne,pointer_previous:Oe,pointer_active:qe,pointer_type:He,pointer_buttons:Xe,reverse:Ze,ctrl:Ge,shift:Ke,button:Ve,pointer_over_canvas:Ye,update_helper_layer_on_pointermove_active:Je,pointers:Qe}=window.globAppstate;console.log("함수 실행:","setSession");const o=(...n)=>{var e;(e=window.console)==null||e.log(...n)};let C=!1;try{localStorage._available=!0,C=localStorage._available,delete localStorage._available}catch{}const G=1,K=()=>c.ctx.getImageData(0,0,c.width,c.height).data.some(n=>n>G);let m;function E(n){m==null||m.close();const e=m=$DialogWindow();e.on("close",()=>{m=null}),e.title("Recover Document");let t=!1;try{window.localStorage.getItem("bogus test key")}catch{t=!0}e.$main.append($(`
         <p>Woah! The canvas became empty.</p>
         <p>If this was on purpose, please ignore this message.</p>
         <p>
            If the canvas was cleared due to memory usage,<br>
            click Undo to recover the document.
         </p>
         <!--<p>Remember to save with <b>File > Save</b>!</p>-->
         ${t?"<p><b>Note:</b> No automatic backup is possible unless you enable Cookies in your browser.</p>":n?`<hr>
                  <p style="opacity: 0.8; font-size: 0.9em;">
                     Auto-save is paused while this dialog is open.
                  </p>
                  <p style="opacity: 0.8; font-size: 0.9em;">
                     (See <b>File &gt; Manage Storage</b> to view backups.)
                  </p>`:""}
      `));const s=e.$Button("Undo",()=>{re()}),a=e.$Button("Redo",()=>{le()}),i=()=>{s.prop("disabled",I.length<1),a.prop("disabled",Z.length<1)};h.on("session-update.session-hook",i),i(),e.$Button(localize("Close"),()=>{e.close()}),e.center(),e.find("button:enabled").focus()}let M=I.length;function D(){const n=m&&!m.closed;let e=!1;return K()?n&&(I.length>M&&E(!0),e=!0):(n||E(),e=!0),M=I.length,e}class x{constructor(e){this.id=e;const t=`image#${e}`;o(`Local storage key: ${t}`),this.save_image_to_storage_immediately=()=>{D()||(o(`Saving image to storage: ${t}`),N.set(t,c.toDataURL("image/png"),a=>{}))},this.save_image_to_storage_soon=T(this.save_image_to_storage_immediately,100),N.get(t,(s,a)=>{s?C?u("Failed to retrieve image from local storage.",s):U({message:"Please enable local storage in your browser's settings for local backup. It may be called Cookies, Storage, or Site Data."}):a?P(a).then(i=>{W(i,null,null,!0,!0)},i=>{u("Failed to open image from local storage.",i)}):this.save_image_to_storage_soon()}),h.on("session-update.session-hook",()=>{this.save_image_to_storage_soon()})}end(){this.save_image_to_storage_soon.cancel(),this.save_image_to_storage_immediately(),h.off(".session-hook")}}let k;const l={cursor:{x:0,y:0,away:!0},tool:localize("Pencil"),hue:~~(Math.random()*360),saturation:~~(Math.random()*50)+50,lightness:~~(Math.random()*40)+50};l.color=`hsla(${l.hue}, ${l.saturation}%, ${l.lightness}%, 1)`,l.color_transparent=`hsla(${l.hue}, ${l.saturation}%, ${l.lightness}%, 0.5)`,l.color_desaturated=`hsla(${l.hue}, ${~~(l.saturation*.4)}%, ${l.lightness}%, 0.8)`;const f=new Image;f.src="images/cursors/default.png";class w{constructor(e){this.id=e,this._fb_listeners=[],p=`[Loading ${this.id}]`,b();const t=()=>{p=`[${this.id}]`,b(),this.start()};if(w.fb_root)t();else{var s=document.createElement("script");s.addEventListener("load",()=>{const a={apiKey:"AIzaSyBgau8Vu9ZE8u_j0rp-Lc044gYTX5O3X9k",authDomain:"jspaint.firebaseapp.com",databaseURL:"https://jspaint.firebaseio.com",projectId:"firebase-jspaint",storageBucket:"",messagingSenderId:"63395010995"};firebase.initializeApp(a),w.fb_root=firebase.database().ref("/"),t()}),s.addEventListener("error",()=>{u("Failed to load Firebase; the document will not load, and changes will not be saved."),p=`[Failed to load ${this.id}]`,b()}),s.src="lib/firebase.js",document.head.appendChild(s)}}start(){U({messageHTML:`
               <p>The document may not load. Changes may not save.</p>
               <p>Multiuser sessions are public. There is no security.</p>
            `});const e=(a,i,r,_)=>{this._fb_listeners.push({fb:a,event_type:i,callback:r,error_callback:_}),a.on(i,r,_)};this.fb=w.fb_root.child(this.id),this.fb_data=this.fb.child("data"),this.fb_users=this.fb.child("users"),k?this.fb_user=this.fb_users.child(k):(this.fb_user=this.fb_users.push(),k=this.fb_user.key),this.fb_user.onDisconnect().remove(),this.fb_user.set(l),e(this.fb_users,"child_added",a=>{if(a.key===k)return;const i=a.ref;let r=a.val();const _=A(32,32),y=$(_).addClass("user-cursor").appendTo($app);y.css({display:"none",position:"absolute",left:0,top:0,opacity:0,zIndex:5,pointerEvents:"none",transition:"opacity 0.5s"}),e(i,"value",R=>{if(r=R.val(),r==null)y.remove();else{const B=()=>{_.width=f.width,_.height=f.height;const v=_.ctx;v.fillStyle=r.color,v.fillRect(0,0,_.width,_.height),v.globalCompositeOperation="multiply",v.drawImage(f,0,0),v.globalCompositeOperation="destination-atop",v.drawImage(f,0,0)};f.complete?B():$(f).one("load",B);const j=window.globApp.canvas_bounding_client_rect;y.css({display:"block",position:"absolute",left:j.left+magnification*r.cursor.x,top:j.top+magnification*r.cursor.y,opacity:1-r.cursor.away})}})});let t;this.write_canvas_to_database_immediately=()=>{if(D())return;const i=c.toDataURL();t!==i?(o("Write canvas data to Firebase"),this.fb_data.set(i),t=i):o("(Don't write canvas data to Firebase; it hasn't changed)")},this.write_canvas_to_database_soon=T(this.write_canvas_to_database_immediately,100);let s=!1;h.on("session-update.session-hook",()=>{if(s){o("(Ignore session-update from Sync Session undoable)");return}this.write_canvas_to_database_soon()}),e(this.fb_data,"value",a=>{o("Firebase data update");const i=a.val();if(i==null)this.write_canvas_to_database_soon();else{t=i;const r=new Image;r.onload=()=>{const _=A(r),y=_.ctx.getImageData(0,0,_.width,_.height),R=S.getImageData(0,0,c.width,c.height);q(y,R,5)||(s=!0,H({name:"Sync Session",icon:X("p_database.png")},()=>{S.copy(r),$canvas_area.trigger("resize")}),s=!1)},r.src=i}},a=>{u("Failed to retrieve data from Firebase. The document will not load, and changes will not be saved.",a),p=`[Failed to load ${this.id}]`,b()}),h.on("pointermove.session-hook",a=>{const i=ne(a);this.fb_user.child("cursor").update({x:i.x,y:i.y,away:!1})}),h.on("blur.session-hook",()=>{this.fb_user.child("cursor").update({away:!0})})}end(){this.write_canvas_to_database_soon.cancel(),this.write_canvas_to_database_immediately(),h.off(".session-hook"),this._fb_listeners.forEach(({fb:e,event_type:t,callback:s,_error_callback:a})=>{o(`Remove listener for ${e.path.toString()} .on ${t}`),e.off(t,s)}),this._fb_listeners.length=0,this.fb_user.remove(),$app.find(".user-cursor").remove(),O()}}w.fb_root=null;class V{constructor(e){this.id=e,p=`[Loading ${this.id}]`,b(),this.start(),this._previous_uri="",this._ignore_session_update=!1,this._poll_tid=-1,this._poll_fetch_start_time=-1,this._last_write_time=-1}async _write_canvas_to_server_immediately(){if(D())return;const t=c.toDataURL();this._previous_uri!==t?(o("Write canvas data to server"),this._previous_uri=t,this._last_write_time=performance.now(),await fetch(`/api/rooms/${this.id}/data`,{method:"PUT",body:t}),this._last_write_time=performance.now()):o("(Don't write canvas data to server; it hasn't changed)")}start(){this._write_canvas_to_server_soon=T(this._write_canvas_to_server_immediately,100),h.on("session-update.session-hook",()=>{if(this._ignore_session_update){o("(Ignore session-update from Sync Session undoable)");return}this._write_canvas_to_server_soon(),this._last_write_time=performance.now()});const e=async()=>{let t;try{this._poll_fetch_start_time=performance.now();const s=await fetch(`/api/rooms/${this.id}/data`);s.status===404?t=null:t=await s.text()}catch(s){u("Failed to load image document from the server.",s),p=`[Failed to load ${this.id}]`,b();return}p=`[${this.id}]`,b(),this.handle_data_snapshot(t,this._poll_fetch_start_time),this._poll_tid=setTimeout(e,1e3)};e()}handle_data_snapshot(e,t){if(!e)this._write_canvas_to_server_soon(),this._last_write_time=performance.now();else{this._previous_uri=e;const s=new Image;s.onload=()=>{if(this._last_write_time>t){o("(Ignore stale image data)");return}const a=A(s),i=a.ctx.getImageData(0,0,a.width,a.height),r=S.getImageData(0,0,c.width,c.height);q(i,r,5)||(this._ignore_session_update=!0,H({name:"Sync Session",icon:X("p_database.png")},()=>{S.copy(s),$canvas_area.trigger("resize")}),this._ignore_session_update=!1)},s.onerror=()=>{u("Failed to load image document from the server. Invalid image data.",e)},s.src=e}}end(){clearTimeout(this._poll_tid),this._write_canvas_to_server_soon.cancel(),this._write_canvas_to_server_immediately(),h.off(".session-hook"),$app.find(".user-cursor").remove(),O()}}let d;const g=()=>{d&&(o("Ending current session"),d.end(),d=null)},F=()=>(Math.random()*2**32).toString(16).replace(".",""),L=()=>{const n=location.hash.match(/^#?(?:.*,)?(session|local):(.*)$/i),e=location.hash.match(/^#?(?:.*,)?(load):(.*)$/i);if(n){const t=n[1].toLowerCase()==="local",s=n[2];if(s==="")o("Invalid session ID; session ID cannot be empty"),g();else if(!t&&s.match(/[./[\]#$]/))o("Session ID is not a valid Firebase location; it cannot contain any of ./[]#$"),g();else if(!s.match(/[-0-9A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02af\u1d00-\u1d25\u1d62-\u1d65\u1d6b-\u1d77\u1d79-\u1d9a\u1e00-\u1eff\u2090-\u2094\u2184-\u2184\u2488-\u2490\u271d-\u271d\u2c60-\u2c7c\u2c7e-\u2c7f\ua722-\ua76f\ua771-\ua787\ua78b-\ua78c\ua7fb-\ua7ff\ufb00-\ufb06]+/))o("Invalid session ID; it must consist of 'alphanumeric-esque' characters"),g();else if(d&&d.id===s&&t===d instanceof x)o("Hash changed but the session ID and session type are the same");else{g();let a="FirebaseSession";try{a=localStorage.online_session_implementation||a}catch{}t?(o(`Starting a new LocalSession, ID: ${s}`),d=new x(s)):a==="RESTSession"?(o(`Starting a new RESTSession, ID: ${s}`),d=new V(s)):a==="FirebaseSession"?(o(`Starting a new FirebaseSession, ID: ${s}`),d=new w(s)):(u(`Invalid online session implementation '${a}'`),d=new x(s))}}else if(e){const t=decodeURIComponent(e[2]);if(oe(t).length===0){u("Invalid URL to load (after #load: in the address bar). It must include a protocol (https:// or http://)");return}o("Switching to new session from #load: URL (to #local: URL with session ID)"),g(),z("local",F()),P(t).then(a=>{W(a,null,null,!0,!0)},ie)}else{o("No session ID in hash");const t=location.hash;g(),z("local",F(),{replace_history_state:!0}),o("After replaceState:",location.hash),t===location.hash?u("Autosave is disabled. Failed to update URL to start session."):L()}};h.on("hashchange popstate change-url-params",n=>{o(n.type,location.hash),L()});const Y=()=>{g(),o("Changing URL to start new session..."),z("local",F())};o("Initializing with location hash:",location.hash),L(),window.new_local_session=Y}export{ss as preSetting,ts as setSession};
